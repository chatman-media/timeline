# Описание работы плеера

## Общая архитектура

Плеер представляет собой React-компонент, который обеспечивает воспроизведение видео с различными функциями управления. Он состоит из нескольких основных компонентов:

1. **MediaPlayer** - основной компонент, который управляет воспроизведением видео
2. **PlayerControls** - компонент с элементами управления (кнопки воспроизведения, паузы, перемотки и т.д.)
3. **Timeline** - компонент для отображения временной шкалы и навигации по видео

Плеер использует контекст React (`usePlayerContext`) для хранения и передачи состояния между компонентами.

## Основные функции плеера

### 1. Воспроизведение видео

- Плеер поддерживает воспроизведение видео с различными форматами и кодеками
- Управление воспроизведением (play/pause) через кнопки или клавиатуру
- Автоматическое возобновление воспроизведения после загрузки видео
- Обработка ошибок воспроизведения с автоматическими попытками восстановления

### 2. Навигация по видео

- Перемотка вперед/назад с помощью кнопок или слайдера
- Переход к определенному времени через слайдер или временную шкалу
- Переход к началу/концу видео
- Покадровая навигация (вперед/назад на один кадр)

### 3. Работа с параллельными видео

- Поддержка нескольких видео, снятых одновременно с разных камер
- Переключение между параллельными видео с сохранением относительной позиции
- Синхронизация времени между параллельными видео
- Обработка видео разной длительности с сохранением пропорциональной позиции

### 4. Запись

- Возможность записи во время воспроизведения
- Автоматическое возобновление записи после переключения между видео
- Корректная обработка записи при переключении между параллельными видео

### 5. Управление временем

- Поддержка как относительного времени, так и Unix timestamp
- Сохранение времени для каждого видео отдельно
- Сохранение времени для каждого сектора (дня)
- Восстановление позиции воспроизведения при переключении между видео

## Детальное описание работы

### Инициализация видео

1. При монтировании компонента `MediaPlayer` или изменении активного видео:

   - Создается видео-элемент и устанавливается источник (src)
   - Добавляются обработчики событий (loadedmetadata, timeupdate, error и т.д.)
   - Инициализируется начальное время воспроизведения

2. При загрузке метаданных видео:
   - Определяется длительность видео
   - Устанавливается начальное время воспроизведения:
     - Если есть сохраненное время для этого видео, используется оно
     - Если нет, но есть параллельные видео, вычисляется пропорциональное время
     - В противном случае используется 0 или сохраненное время для сектора

### Воспроизведение и пауза

1. При нажатии на кнопку воспроизведения/паузы:

   - Если идет процесс переключения камеры, действие игнорируется
   - Иначе переключается состояние `isPlaying`
   - При паузе сохраняется текущее время воспроизведения
   - При воспроизведении устанавливается сохраненное время и запускается видео

2. Во время воспроизведения:
   - Обновляется текущее время (`currentTime`) для отображения на слайдере
   - Сохраняется время для текущего видео
   - Обновляется положение слайдера и временной шкалы

### Переключение между параллельными видео

1. При нажатии на кнопку переключения камеры:

   - Проверяется, не идет ли уже процесс переключения
   - Сохраняется текущее время воспроизведения
   - Вычисляется относительная позиция (текущее время / длительность)
   - Если активна запись, она временно приостанавливается
   - Устанавливается флаг `isChangingCamera`
   - Устанавливается новое активное видео

2. После установки нового видео:
   - Вычисляется новое время на основе относительной позиции и длительности нового видео
   - Устанавливается новое время для видео-элемента
   - Сбрасывается флаг `isChangingCamera`
   - Если была активна запись, она возобновляется
   - Если видео было на паузе, но была активна запись, запускается воспроизведение

### Перемещение слайдера

1. При перемещении слайдера:
   - Если идет процесс переключения камеры, действие игнорируется
   - Вычисляется новое время на основе положения слайдера
   - Устанавливается флаг `isSeeking`
   - Устанавливается новое время для видео-элемента
   - Если есть параллельные видео, синхронизируется их время пропорционально
   - Сбрасывается флаг `isSeeking`

### Запись

1. При нажатии на кнопку записи:

   - Если идет процесс переключения камеры, действие игнорируется
   - Переключается состояние `isRecording`
   - Если начинается запись и видео на паузе, автоматически запускается воспроизведение

2. Во время записи:
   - Если происходит переключение между видео, запись временно приостанавливается
   - После завершения переключения запись автоматически возобновляется
   - Если видео было на паузе, но была активна запись, запускается воспроизведение

## Обработка ошибок и восстановление

1. При возникновении ошибок воспроизведения:

   - Логируется ошибка
   - Сбрасывается состояние воспроизведения
   - Предпринимаются попытки восстановления (перезагрузка видео, повторная установка src)

2. При ошибках во время переключения между видео:
   - Сбрасывается флаг `isChangingCamera`
   - Если была активна запись, она возобновляется
   - Логируется ошибка для отладки

## Оптимизация производительности

1. Использование `useRef` для хранения значений, которые не должны вызывать перерендер
2. Оптимизация обновлений времени с использованием порогов изменения
3. Отложенное обновление UI для уменьшения количества перерендеров
4. Использование `useCallback` для мемоизации функций
5. Контроль зависимостей в `useEffect` для предотвращения лишних вызовов

## Синхронизация состояния

1. Использование контекста React для централизованного хранения состояния
2. Сохранение времени для каждого видео отдельно
3. Сохранение времени для каждого сектора (дня)
4. Синхронизация времени между параллельными видео при переключении
5. Обработка Unix timestamp и относительного времени

## Особенности реализации

### Обработка параллельных видео

При переключении между параллельными видео с разной длительностью сохраняется относительная позиция воспроизведения. Например, если первое видео было на позиции 30% от общей длительности, то при переключении на второе видео будет установлена та же относительная позиция (30% от длительности второго видео).

### Обработка времени

Плеер поддерживает два типа времени:

1. **Относительное время** - время от начала видео в секундах
2. **Unix timestamp** - абсолютное время в секундах с 1 января 1970 года

При работе с Unix timestamp плеер автоматически вычисляет относительное время для каждого видео на основе его startTime.

### Обработка записи

При записи плеер обеспечивает непрерывность процесса даже при переключении между видео. Запись временно приостанавливается во время переключения и автоматически возобновляется после его завершения.
