# Списки

## Компоненты

### MediaFilesList
Компонент для отображения списка медиафайлов с возможностью предпросмотра и управления воспроизведением.

#### Основной функционал:
- Отображение списка видео и аудио файлов с метаданными
- Предпросмотр видео при наведении курсора
- Воспроизведение с выбранной позиции
- Добавление файлов в треки
- Визуальная временная шкала

#### Особенности реализации:
1. **Предпросмотр времени**
   - При наведении курсора на миниатюру отображается красная линия-индикатор
   - Над линией показывается точное время в формате ЧЧ:ММ:СС
   - Видео автоматически перематывается на соответствующую позицию
   - Работает как для видео, так и для аудио файлов

2. **Управление воспроизведением**
   - Кнопка play/pause появляется при наведении на миниатюру
   - При нажатии воспроизведение начинается с текущей позиции курсора
   - Поддерживается циклическое воспроизведение (loop)

3. **Работа с треками**
   - Каждый файл можно добавить в трек
   - Поддерживается группировка файлов по одинковым камерам
   - Возможность добавления всех файлов в треки одним действием
   - Автоматический расчет временных диапазонов при добавлении

4. **Отображение метаданных**
   - Название файла
   - Размер файла
   - Разрешение видео
   - Длительность
   - Дата и время создания
   - Тип кодека

#### Технические детали:

```typescript
interface MediaFile {
  id: string
  name: string
  path: string
  thumbnail?: string
  isVideo: boolean
  probeData?: {
    format: {
      duration: number
      size: number
      creation_time: number
    }
    streams: Array<{
      codec_type: string
      width?: number
      height?: number
      codec_name?: string
    }>
  }
}
```

#### Состояния компонента:
- `playingFileId`: ID текущего воспроизводимого файла
- `hoverTimes`: временные метки при наведении для каждого файла
- `videoRefs`: ссылки на HTML элементы видео/аудио
- `tracks`: массив созданных треков

#### Обработка событий:
- `handleMouseMove`: расчет времени по позиции курсора
- `handlePlayPause`: управление воспроизведением
- `handleAddToTrack`: добавление файла в новый трек
- `handleAddAllFiles`: группировка и добавление всех файлов в треки

## Принцип работы

### Инициализация компонента
1. При монтировании компонент получает список медиафайлов через хук `useMedia`
2. Для каждого файла создаются ref-ссылки для управления воспроизведением
3. Инициализируются состояния для отслеживания воспроизведения и временных меток

### Предпросмотр при наведении
1. При наведении курсора на миниатюру:
   - Вычисляется позиция курсора относительно ширины миниатюры
   - Рассчитывается соответствующее время видео
   - Обновляется состояние `hoverTimes` для конкретного файла
   - Видео/аудио перематывается на расчетную позицию
   - Отображается временная линия и метка времени

2. Временная линия:
   - Красная вертикальная полоса показывает текущую позицию
   - Над полосой отображается точное время
   - Положение обновляется в реальном времени при движении курсора
   - При выходе за пределы миниатюры индикаторы скрываются

### Воспроизведение
1. При нажатии на кнопку play:
   - Если есть активная временная метка, воспроизведение начинается с неё
   - Иначе воспроизведение начинается с начала файла
   - Обновляется `playingFileId`
   - Файл воспроизводится в цикле (loop)

2. При нажатии на pause:
   - Воспроизведение останавливается
   - `playingFileId` сбрасывается
   - Сохраняется текущая позиция воспроизведения

### Добавление в треки
1. Добавление одного файла:
   - Создается новый трек с уникальным ID
   - Рассчитывается временной диапазон
   - Трек добавляется в общий список треков
   - Проверяется уникальность добавления

2. Добавление всех файлов:
   - Файлы группируются по камерам
   - Для каждой группы создается отдельный трек
   - Рассчитываются общие временные диапазоны
   - Все треки добавляются в список одновременно

### Оптимизация
- Предварительная загрузка видео через `preload="auto"`
- Использование `ref` для прямого доступа к элементам медиа
- Кэширование расчетов временных диапазонов
- Отложенная загрузка миниатюр
- Эффективное обновление состояний для плавной анимации

### Обработка ошибок
- Проверка корректности временных меток
- Валидация позиции курсора
- Обработка отсутствующих миниатюр
- Fallback для неподдерживаемых форматов

### Интерактивное управление воспроизведением
1. **Автоматическое воспроизведение при наведении**
   - При наведении курсора на миниатюру показывается временная шкала
   - Видео/аудио автоматически перематывается на позицию курсора
   - Поддерживается множественный предпросмотр для файлов с несколькими потоками

2. **Управление по клику**
   - Клик на миниатюру запускает воспроизведение
   - Повторный клик останавливает воспроизведение
   - При воспроизведении одного файла, другие автоматически останавливаются
   - Воспроизведение начинается с позиции предпросмотра, если она активна

3. **Автоматическая остановка**
   - При уходе курсора с миниатюры воспроизведение автоматически останавливается
   - Временная шкала и индикаторы скрываются
   - Состояние воспроизведения сбрасывается

### Визуальные индикаторы
1. **Многопоточные файлы**
   - Для файлов с несколькими видеопотоками отображается номер потока
   - Индикатор располагается в верхней части миниатюры
   - Адаптивное позиционирование для горизонтальных и вертикальных видео

2. **Аудио индикаторы**
   - Специальная иконка для файлов с аудиопотоком
   - Отображается в нижней части миниатюры
   - Адаптивное позиционирование в зависимости от ориентации видео

### Адаптивный интерфейс
1. **Размеры миниатюр**
   - Автоматический расчет размеров с сохранением пропорций
   - Учет поворота видео при расчете размеров
   - Оптимизированное отображение для горизонтальных и вертикальных видео

2. **Состояния загрузки**
   - Отображение скелетона во время загрузки миниатюр
   - Плавное появление контента после загрузки
   - Обработка ошибок загрузки медиафайлов

### Группировка и статистика
1. **Анализ последовательностей**
   - Автоматическое определение серий последовательных записей
   - Группировка файлов по базовому имени
   - Отображение статистики по сериям в нижней панели

2. **Информационная панель**
   - Отображение общего количества видео и аудио файлов
   - Статистика по сериям последовательных записей
   - Быстрый доступ к функции добавления всех файлов

### Технические особенности реализации
1. **Оптимизация производительности**
   - Использование useCallback для обработчиков событий
   - Мемоизация расчетов с помощью useMemo
   - Эффективное управление референсами медиаэлементов

2. **Обработка метаданных**
   - Извлечение времени создания из различных источников метаданных
   - Парсинг даты создания из имени файла при отсутствии метаданных
   - Форматирование временных меток с поддержкой миллисекунд

3. **Управление состоянием**
   - Централизованное хранение состояния воспроизведения
   - Координация между множественными медиаплеерами
   - Эффективное обновление UI при изменении состояния

### Примеры использования

```typescript
// Пример обработки воспроизведения
const handlePlayPause = async (e: React.MouseEvent, fileId: string) => {
  const baseFileId = fileId.split('-')[0]
  const mediaElement = videoRefs.current[fileId]

  if (mediaElement) {
    if (playingFileId === baseFileId) {
      await mediaElement.pause()
      setPlayingFileId(null)
    } else {
      await mediaElement.play()
      setPlayingFileId(baseFileId)
    }
  }
}

// Пример автоматической остановки
const handleMouseLeave = async (fileId: string) => {
  const baseFileId = fileId.split('-')[0]
  if (playingFileId === baseFileId) {
    Object.entries(videoRefs.current)
      .filter(([key]) => key.startsWith(baseFileId))
      .forEach(([, player]) => player?.pause())
    setPlayingFileId(null)
  }
}
```
