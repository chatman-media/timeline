# Модуль управления видео

## Общая архитектура

Модуль построен вокруг концепции параллельных видеопотоков (треков), где каждый трек представляет собой последовательность видеофайлов часто с одной камеры. Система позволяет переключаться между треками, сохраняя временную синхронизацию между ними.

## Основные концепции

### Треки
- Трек - это последовательность видеофайлов
- Каждый трек имеет свой уникальный идентификатор
- Треки могут иметь разные временные промежутки записи
- В один момент времени активен один или несколько треков
- Поддерживаются различные схемы разделения экрана (2x2, 3x3, etc.)

```typescript
interface Track {
  id: string // Ключ камеры
  index: number // Номер камеры, начиная с 1
  isActive: boolean // Флаг активности трека
  combinedDuration: number // Общая длительность видео
  videos: MediaFile[] // Все видео этой камеры
  timeRanges: TimeRange[] // Массив временных диапазонов
}
```

### Временные диапазоны
- Каждый трек содержит набор временных диапазонов
- Диапазоны определяют периоды, когда доступна запись
- Система поддерживает общий временной диапазон для всех треков
- Пробелы между записями автоматически обрабатываются

````typescript
interface TimeRange {
  start: number // время начала в секундах
  end?: number // время окончания в секундах
  duration: number // длительность в секундах
}
````

### Активное состояние
- В каждый момент времени определено:
  - Активный трек (один или несколько)
  - Активное видео внутри трека
  - Текущее время воспроизведения
- При переключении между треками система автоматически находит соответствующее видео для текущего времени

## Принцип работы

### Инициализация
1. Загрузка метаданных всех доступных видеофайлов
2. Группировка видео по трекам
3. Расчёт временных диапазонов для каждого трека
4. Определение общего временного диапазона

### Воспроизведение
1. Пользователь выбирает время воспроизведения
2. Система определяет доступные треки для этого времени
3. При переключении между треками:
   - Определяется подходящее видео в новом треке
   - Производится предварительная загрузка соседних видео
   - Обеспечивается плавный переход

## Особенности реализации

### Временная синхронизация
- Все видео имеют метки времени создания
- Система учитывает возможные погрешности в метках времени (например при переходе между записями)
- Поддерживается точная синхронизация между треками

### Производительность
- Предварительная загрузка соседних видео
- Кэширование метаданных
- Быстрый поиск нужного видео по временным меткам

### Отказоустойчивость
- Обработка отсутствующих видеофайлов
- Поддержка треков с пропусками в записи
- Корректная обработка ошибок загрузки

## Ограничения
- Все видео должны иметь корректные метки времени создания
- Требуется правильная последовательность видеофайлов в треке
- Необходимо достаточно памяти для предварительной загрузки

## Возможности расширения
- Добавление новых типов треков
- Расширение метаданных видео
- Улучшение алгоритмов синхронизации
- Оптимизация использования памяти

## Технические детали

### Структура данных


### Ключевые состояния

- `tracks`: массив всех треков
- `activeTrackId`: ID активного трека
- `activeVideo`: текущее активное видео
- `currentTime`: текущее время воспроизведения
- `timeRanges`: общие временные диапазоны

### Важные методы

- `setActiveTrack`: выбор активного трека
- `setCurrentTime`: установка текущего времени
- `fetchVideos`: загрузка и инициализация видео и треков
